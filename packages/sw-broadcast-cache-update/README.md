# sw-broadcast-cache-update

A helper library that uses the Broadcast Channel API to announce when two Response objects differ.

## Installation

`npm install --save-dev sw-broadcast-cache-update`

## Demo

Browse sample source code in the [demo directory](https://github.com/GoogleChrome/sw-helpers/tree/future-of-sw-tooling/packages/sw-broadcast-cache-update/demo), or
[try it out](https://googlechrome.github.io/sw-helpers/sw-broadcast-cache-update/demo/) directly.

## API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### sw-broadcast-cache-update

[packages/sw-broadcast-cache-update/src/index.js:21-21](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/index.js#L21-L21 "Source code on GitHub")

sw-broadcast-cache-update Module

### Behavior

[packages/sw-broadcast-cache-update/src/lib/behavior.js:68-160](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/behavior.js#L68-L160 "Source code on GitHub")

**Examples**

```javascript
// Used as an automatically invoked as "behavior" by a RequestWrapper:

const requestWrapper = new goog.runtimeCaching.RequestWrapper({
  cacheName: 'runtime-cache',
  behaviors: [
    new goog.broadcastCacheUpdate.Behavior({channelName: 'cache-updates'})
  ]
});

// Set up a route to match any requests made against the example.com domain.
// The requests will be handled with a stale-while-revalidate policy, and the
// cache update notification behavior, as configured in requestWrapper, will
// be automatically applied.
const route = new goog.routing.RegExpRoute({
  match: ({url}) => url.domain === 'example.com',
  handler: new goog.runtimeCaching.StaleWhileRevalidate({requestWrapper})
});
```

```javascript
// Explicitly invoked usage independent of the goog.routing framework, via
// the notifyIfUpdated() method:

const cacheUpdateBehavior = new goog.broadcastCacheUpdates.Behavior({
  channelName: 'cache-updates'
});

const url = 'https://example.com';
const cacheName = 'runtime-cache';

const cache = await caches.open(cacheName);
const oldResponse = await cache.match(url);
const newResponse = await fetch(url);
await cache.put(url, newResponse);

// Only check for an update if there was a previously cached Response.
if (oldResponse) {
  cacheUpdateBehavior.notifyIfUpdated({
    first: oldResponse,
    second: newResponse,
    cacheName
  });
}
```

### broadcastUpdate

[packages/sw-broadcast-cache-update/src/lib/broadcast-update.js:55-69](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/broadcast-update.js#L55-L69 "Source code on GitHub")

Uses the [Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
to notify interested subscribers about a change to a cached resource.

You would not normally call this method directly; it's called automatically
by an instance of the [Behavior](#behavior) class. It's exposed here for the
benefit of developers who would rather not use the full `Behavior`
implementation.

The message that's posted takes the following format, inspired by the
[Flux standard action](https://github.com/acdlite/flux-standard-action#introduction)
format. (Usage of [Flux](https://facebook.github.io/flux/) itself is not at
all required.)

    {
      type: 'CACHE_UPDATED',
      meta: 'sw-broadcast-cache-update',
      payload: {
        cacheName: 'the-cache-name',
        updatedUrl: 'https://example.com/'
      }
    }

**Parameters**

-   `input` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `input.channel` **BroadcastChannel** The `BroadcastChannel` to use.
    -   `input.cacheName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The name of the cache in which the updated
               `Response` was stored.
    -   `input.url` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The URL associated with the updated `Response`.
    -   `input.source` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** A string identifying this library as the source
               of the update message.
-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.channel`  
    -   `$0.cacheName`  
    -   `$0.url`  
    -   `$0.source`  

### cacheUpdatedMessageType

[packages/sw-broadcast-cache-update/src/lib/constants.js:22-22](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/constants.js#L22-L22 "Source code on GitHub")

The value `'CACHE_UPDATED'`, used as the `type` field of the update message.

### responsesAreSame

[packages/sw-broadcast-cache-update/src/lib/responses-are-same.js:33-42](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/responses-are-same.js#L33-L42 "Source code on GitHub")

Given two `Response`s, compares several header values to see if they are
the same or not.

**Parameters**

-   `input` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `input.first` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** One of the `Response`s.
    -   `input.second` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** Another of the `Response`s.
    -   `input.headersToCheck` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)>** A list of headers that will be
               used to determine whether the `Response`s differ.
-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.first`  
    -   `$0.second`  
    -   `$0.headersToCheck`  

Returns **[boolean](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** Whether or not the `Response` objects are assumed to be
        the same.

### constructor

[packages/sw-broadcast-cache-update/src/lib/behavior.js:89-95](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/behavior.js#L89-L95 "Source code on GitHub")

Creates a new `Behavior` instance, which is used to compare two
[Responses](https://developer.mozilla.org/en-US/docs/Web/API/Response)
and use the [Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
to notify interested parties when those Responses differ.

For efficiency's sake, the underlying response bodies are not compared;
only specific response headers are checked.

**Parameters**

-   `input` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The input object to this function.
    -   `input.channelName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** The name that will be used when creating
               the [`BroadcastChannel`](https://developer.mozilla.org/en-US/docs/Web/API/BroadcastChannel/BroadcastChannel).
    -   `input.headersToCheck` **[Array](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Array)&lt;[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)>** A list of headers that will be
               used to determine whether the `Response`s differ. If not provided,
               the values `['content-length', 'etag', 'last-modified']` are used.
    -   `input.source` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** An attribution value that will be used in the
               broadcast message to indicate where the update originated. If not
               provided, a
               [default value](constants#defaultSource) will be used.
-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.channelName`  
    -   `$0.headersToCheck`  
    -   `$0.source`  

### notifyIfUpdated

[packages/sw-broadcast-cache-update/src/lib/behavior.js:151-159](https://github.com/GoogleChrome/sw-helpers/blob/a6f471056b52998c278dcb22dfc96169ea99932a/packages/sw-broadcast-cache-update/src/lib/behavior.js#L151-L159 "Source code on GitHub")

An explicit method to call from your own code to trigger the comparison of
two [Response](https://developer.mozilla.org/en-US/docs/Web/API/Response)
and fire off a notification via the
[Broadcast Channel API](https://developers.google.com/web/updates/2016/09/broadcastchannel)
if they differ.

**Parameters**

-   `input` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** The input object to this function.
    -   `input.first` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** One of the responses to compare.
               This should not be an [opaque response](http://stackoverflow.com/questions/39109789).
    -   `input.second` **[Response](https://developer.mozilla.org/en-US/docs/Web/Guide/HTML/HTML5)** Another of the respones to compare.
               This should not be an [opaque response](http://stackoverflow.com/questions/39109789).
    -   `input.cacheName` **[string](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/String)** Name of the cache the Responses belong to.
-   `$0` **[Object](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
    -   `$0.first`  
    -   `$0.second`  
    -   `$0.cacheName`  
